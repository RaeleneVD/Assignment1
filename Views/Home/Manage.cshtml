@{
    ViewBag.Title = "Manage";
}

<style>
    .section {
        margin-bottom: 50px;
    }

        .section h3 {
            margin-bottom: 20px;
        }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #dee2e6;
        padding: 10px;
        text-align: left;
    }

    th {
        background-color: #f8f9fa;
    }

    .form-inline .form-control {
        display: inline-block;
        width: auto;
        margin-right: 10px;
    }

    .form-inline .btn {
        vertical-align: middle;
    }

    .table-img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4">Driver and Vehicle Management</h2>

    <!-- Drivers Section -->
    <div class="section">
        <h3>Drivers</h3>

        <!-- Driver Form -->
        <form id="driverForm" class="form-inline mb-3">
            <input type="hidden" id="driverIndex" value="-1" />
            <input type="text" class="form-control" id="driverName" placeholder="Driver Name" required />
            <input type="text" class="form-control" id="driverPhone" placeholder="Phone Number" required />
            <select class="form-control" id="driverService" required>
                <option disabled selected value="">Service</option>
                <option>Basic Life Support</option>
                <option>Advanced Life Support</option>
                <option>Air Ambulance</option>
                <option>Event Medical Ambulance</option>
                <option>Medical Utility Vehicle</option>
                <option>Patient Support</option>
            </select>
            <!--<input type="text" class="form-control" id="driverImage" placeholder="Image filename" />-->
            <button type="submit" class="btn btn-primary">Add Driver</button>
        </form>

        <!-- Driver Table -->
        <table id="driverTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Service</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!--Vehicles Section -->
    <div class="section">
        <h3>Vehicles</h3>

        <!-- Vehicle Form -->
        <form id="vehicleForm" class="form-inline mb-3">
            <input type="hidden" id="vehicleIndex" value="-1" />
            <input type="text" class="form-control" id="vehicleModel" placeholder="Vehicle Type" required />
            <input type="text" class="form-control" id="vehicleRegistration" placeholder="Registration Number" required />
            <select class="form-control" id="vehicleService" required>
                <option disabled selected value="">Service</option>
                <option>Basic Life Support</option>
                <option>Advanced Life Support</option>
                <option>Air Ambulance</option>
                <option>Event Medical Ambulance</option>
                <option>Medical Utility Vehicle</option>
                <option>Patient Support</option>
            </select>
            <!--<input type="text" class="form-control" id="vehicleImage" placeholder="Image filename" />-->
            <button type="submit" class="btn btn-success">Add Vehicle</button>
        </form>

        <!-- Vehicle Table -->
        <table id="vehicleTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Type</th>
                    <th>Registration</th>
                    <th>Service</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        //Drivers ===============================================================================
        //Get drivers from local storage
        function loadDrivers() {
            const drivers = JSON.parse(localStorage.getItem("drivers") || "[]");
            const tableBody = document.querySelector("#driverTable tbody");
            tableBody.innerHTML = "";

            //add a row with driver information
            drivers.forEach((d, i) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                            <td><img src="/Content/Images/${d.image}" alt="Driver" class="table-img" /></td>
                            <td>${d.name}</td>
                            <td>${d.phone}</td>
                            <td>${d.service}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary me-2" onclick="editDriver(${i})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDriver(${i})">Delete</button>
                            </td>
                        `;
            });
        }
        //edit
        function editDriver(index) {
            const drivers = JSON.parse(localStorage.getItem("drivers") || "[]");
            const d = drivers[index];

            document.getElementById("driverName").value = d.name;
            document.getElementById("driverPhone").value = d.phone;
            document.getElementById("driverService").value = d.service;
            document.getElementById("driverIndex").value = index;
            document.querySelector("#driverForm button[type='submit']").textContent = "Update Driver";
        }

        //delete
        function deleteDriver(index) {
            let drivers = JSON.parse(localStorage.getItem("drivers") || "[]");
            drivers.splice(index, 1);
            localStorage.setItem("drivers", JSON.stringify(drivers));
            loadDrivers();
        }

        //submit buuton
        document.getElementById("driverForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let drivers = JSON.parse(localStorage.getItem("drivers") || "[]");
            const index = parseInt(document.getElementById("driverIndex").value);

            //create driver object
            const newDriver = {
                id: index >= 0 && drivers[index] ? drivers[index].id : crypto.randomUUID(), //random id generated
                name: document.getElementById("driverName").value,
                phone: document.getElementById("driverPhone").value,
                service: document.getElementById("driverService").value,
                image: getRandomImageDriver(document.getElementById("driverService").value)//get driver image
            };

            if (index >= 0) {
                drivers[index] = newDriver;
            } else {
                drivers.push(newDriver);
            }

            localStorage.setItem("drivers", JSON.stringify(drivers));
            this.reset();
            document.getElementById("driverIndex").value = -1;
            document.querySelector("#driverForm button[type='submit']").textContent = "Add Driver";
            loadDrivers();
        });

        //Vehicles =================================================================================
        function loadVehicles() {
            const vehicles = JSON.parse(localStorage.getItem("vehicles") || "[]");
            const tableBody = document.querySelector("#vehicleTable tbody");
            tableBody.innerHTML = "";

            //add row for vehicles
            vehicles.forEach((v, i) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                            <td><img src="/Content/Images/${v.image}" alt="Vehicle" class="table-img" /></td>
                            <td>${v.model}</td>
                            <td>${v.registration}</td>
                            <td>${v.service}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary me-2" onclick="editVehicle(${i})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVehicle(${i})">Delete</button>
                            </td>
                        `;
            });
        }

        //edit
        function editVehicle(index) {
            const vehicles = JSON.parse(localStorage.getItem("vehicles") || "[]");
            const v = vehicles[index];

            document.getElementById("vehicleModel").value = v.model;
            document.getElementById("vehicleRegistration").value = v.registration;
            document.getElementById("vehicleService").value = v.service;
            document.getElementById("vehicleIndex").value = index;
            document.querySelector("#vehicleForm button[type='submit']").textContent = "Update Vehicle";
        }

        //delete
        function deleteVehicle(index) {
            let vehicles = JSON.parse(localStorage.getItem("vehicles") || "[]");
            vehicles.splice(index, 1);
            localStorage.setItem("vehicles", JSON.stringify(vehicles));
            loadVehicles();
        }

        //submit/create button
        document.getElementById("vehicleForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let vehicles = JSON.parse(localStorage.getItem("vehicles") || "[]");
            const index = parseInt(document.getElementById("vehicleIndex").value);


            //create vehicle object
            const newVehicle = {
                id: index >= 0 && vehicles[index] ? vehicles[index].id : crypto.randomUUID(),
                model: document.getElementById("vehicleModel").value,
                registration: document.getElementById("vehicleRegistration").value,
                service: document.getElementById("vehicleService").value,
                image: getRandomImageVehicle(document.getElementById("vehicleService").value)//vehicle picture
            };

            if (index >= 0) {
                vehicles[index] = newVehicle;
            } else {
                vehicles.push(newVehicle);
            }

            localStorage.setItem("vehicles", JSON.stringify(vehicles));
            this.reset();
            document.getElementById("vehicleIndex").value = -1;
            document.querySelector("#vehicleForm button[type='submit']").textContent = "Add Vehicle";
            loadVehicles();
        });

        document.addEventListener("DOMContentLoaded", () => {
            loadDrivers();
            loadVehicles();
        });

        //images

        //get a random image depending on the type
        function getRandomImageVehicle(service) {
            const pools = {
                "Air Ambulance": ["heli.jpg", "heli1.jpg"],
                "Basic Life Support": ["van1.jpg", "van.jpg"],
                "Advanced Life Support": ["heli.jpg", "heli1.jpg", "van1.jpg", "van.jpg"],
                "Event Medical Ambulance": ["heli.jpg", "heli1.jpg", "van1.jpg", "van.jpg"],
                "Medical Utility Vehicle": ["heli.jpg", "heli1.jpg", "van1.jpg", "van.jpg"],
                "Patient Support": ["heli.jpg", "heli1.jpg", "van1.jpg", "van.jpg"]
            };

            const pool = pools[service] || ["default_vehicle.jpg"];
            const randomIndex = Math.floor(Math.random() * pool.length);
            return pool[randomIndex];
        }

        function getRandomImageDriver(service) {
            const pools = {
                "Air Ambulance": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"],
                "Basic Life Support": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"],
                "Advanced Life Support": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"],
                "Event Medical Ambulance": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"],
                "Medical Utility Vehicle": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"],
                "Patient Support": ["driverGirl.jpg", "driverGirl1.jpg", "driverGuy.jpg"]
            };

            const pool = pools[service] || ["generic_driver.jpg"];
            const randomIndex = Math.floor(Math.random() * pool.length);
            return pool[randomIndex];
        }
    </script>
}
